<style>
  body {
    background: black;
    color: white;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
  }

  select, button {
    border: 3px solid white;
    background: rgba(0, 0, 0, 0.8);
    border-radius: 12px;
    color: white;
    padding: 12px;
    font-size: 18px;
  }

  label {
    font-size: 18px;
  }

  .overlay {
    display: flex;
    position: absolute;
    gap: 12px;
    z-index: 2;
  }

  .container {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%
  }

  video {
    background-color: gray;
    filter: invert(100%);
    height: 80vh;
    transition: transform 200ms ease;
  }

  .rotated {
    transform: rotate(90deg);
    width: 80vh;
    height: auto;
  }
</style>

<div class="overlay">
  <div class="select">
    <label for="videoSource"></label>
    <select id="videoSource"></select>
  </div>

  <button class="rotate-button">Rotate</button>
  <!-- <button>Flip</button> -->
</div>

<div class="container">
  <video autoplay muted playsinline></video>
</div>

<script>
  var rotateButton = document.querySelector(".rotate-button");

  var videoElement = document.querySelector("video");
  var videoSelect = document.querySelector("select#videoSource");

  videoSelect.onchange = getStream;

  rotateButton.addEventListener("click", () => {
    videoElement.classList.toggle("rotated")
  })

  getStream().then(getDevices).then(gotDevices);

  function getDevices() {
    // AFAICT in Safari this only gets default devices until gUM is called :/
    return navigator.mediaDevices.enumerateDevices();
  }

  function gotDevices(deviceInfos) {
    window.deviceInfos = deviceInfos; // make available to console
    console.log("Available input and output devices:", deviceInfos);
    for (const deviceInfo of deviceInfos) {
      const option = document.createElement("option");
      option.value = deviceInfo.deviceId;

      if (deviceInfo.kind === "videoinput") {
        option.text = deviceInfo.label || `Camera ${videoSelect.length + 1}`;
        videoSelect.appendChild(option);
      }
    }
  }

  function getStream() {
    if (window.stream) {
      window.stream.getTracks().forEach((track) => {
        track.stop();
      });
    }
    const videoSource = videoSelect.value;

    const constraints = {
      video: { deviceId: videoSource ? { exact: videoSource } : undefined },
    };

    return navigator.mediaDevices
      .getUserMedia(constraints)
      .then(gotStream)
      .catch(handleError);
  }

  function gotStream(stream) {
    window.stream = stream;

    videoSelect.selectedIndex = [...videoSelect.options].findIndex(
      (option) => option.text === stream.getVideoTracks()[0].label
    );
    videoElement.srcObject = stream;
  }

  function handleError(error) {
    console.error("Error: ", error);
  }
</script>
